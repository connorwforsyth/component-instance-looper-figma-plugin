<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
  </head>
  <body class="p-2 bg-gray-100">
    <div class="flex flex-col gap-2 h-full">
      <h2 class="font-bold mb-4">Text List to Component Instances</h2>
      <!-- Textarea for inputting the text list -->
      <textarea
    class=" focus:border-2 focus:outline-none border-2 border-gray-300 p-2 text-sm rounded-md resize-none w-full h-48 mb-4"
    id="text-list-input"
    placeholder="Enter your text list here..."
></textarea>


      <!-- Display the currently selected component instance -->
      <div
        id="selected-component"
      >
      <p class="text-gray-600">
          Select a component instance on the canvas.
        </p>
      </div>

      <div id="generate-buttons" class="hidden *:mb-2 *:text-sm *:p-2 *:rounded-md">
      <!-- Dropdown to select the text property of the selected component instance -->
      <select
        id="text-property-select"
        class="border-2 border-gray-300 w-full focus:ring-1 focus:border-2 focus:outline-none"
        disabled
      >
      <option value="">Select text property</option>
      </select>
      

      <!-- Button to generate instances based on the text list -->
      <button
        id="generate-button"
        class="bg-blue-600 text-white select-none focus:ring-1 focus:outline-none "
        disabled
      >
     
        Generate Instances
        <span class="inline-flex gap-[4px] pl-4 text-xs text-white font-semibold *:rounded-sm *:px-[4px] *:py-[2px] *:bg-blue-500">
          <span>⌘</span>
          <span>↵</span>
        </span>
      </button>
    </div>

    <div class="flex-grow"></div>
      <!-- Display the count of lines in the text list -->
      <div class="font-mono text-xs font w-full border-t-2 py-2">
        <span id="line-count" class="font-bold">0</span>
        <span class="text-gray-700"> Instances to create</span>
      </div>
    </div>
    <script>
      // Function to handle the generate button click
      const generateButton = document.getElementById("generate-button");
      generateButton.onclick = function () {
        GenerateInstances();
      };

      const generateButtons = document.getElementById("generate-buttons");

      function GenerateInstances() {
        const textList = document.getElementById("text-list-input").value;
        const textProperty = document.getElementById(
          "text-property-select"
        ).value;
        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-instances",
              textList,
              textProperty,
            },
          },
          "*"
        );

        // Create an audio object to play the sound effect
        const popSound = new Audio(
          "https://www.myinstants.com/media/sounds/comedy_pop_finger_in_mouth_001.mp3"
        );

        if (popSound) {
          console.log("Playing sound...");
          popSound
            .play()
            .then(() => {
              console.log("Sound played successfully.");
            })
            .catch((error) => {
              console.error("Error playing sound:", error);
            });
        } else {
          console.error("Audio element not created correctly.");
        }
      }

      
      // Function to update the line count
      function updateLineCount() {
        const textList = document.getElementById("text-list-input").value;
        const lines = textList.split("\n").filter((line) => line.trim() !== "");
        const lineCount = lines.length;
        const lineCountDiv = document.getElementById("line-count");
        lineCountDiv.innerHTML = `${lineCount}`;
      }

      // Add event listener to update the line count when the text list changes
      document
        .getElementById("text-list-input")
        .addEventListener("input", updateLineCount);

      // Function to handle messages from the plugin
      onmessage = (event) => {
        const message = event.data.pluginMessage;
        const selectedComponentDiv =
          document.getElementById("selected-component");
        const textPropertySelect = document.getElementById(
          "text-property-select"
        );

        if (message.type === "update-selection") {
          if (message.componentName) {
            selectedComponentDiv.innerHTML = `<p class="text-gray-600 text-sm font-mono">Instance of <span class="font-semibold">${message.componentName}</span> selected.</p>`} else {
            selectedComponentDiv.innerHTML = `<p class="text-gray-600 text-sm font-mono">Select a single <span class="font-semibold">component instance</span> on the canvas.
        </p>`;
          }

          
          if(message.type === "update-selection"){
            if (message.componentName){
            generateButtons.classList.remove("hidden")}
            else {
              generateButtons.classList.add("hidden")
            }
          }

          textPropertySelect.innerHTML =
            '<option value="">Select text property</option>';

          // Populate the dropdown with the available text properties
          message.properties.forEach((property) => {
            const option = document.createElement("option");
            option.value = property.originalKey;
            option.textContent = property.cleanName;
            textPropertySelect.appendChild(option);
          });

          // Remove the placeholder option  
          if (textPropertySelect.options.length > 1) {
            textPropertySelect.remove(0);
          }

          // Set the default selected option to the first property in the list
          if (textPropertySelect.options.length > 0) {
            textPropertySelect.selectedIndex = 0;
          }

          // Enable or disable the dropdown and generate button based on the available properties
          textPropertySelect.disabled = message.properties.length === 0;
          document.getElementById("generate-button").disabled =
            message.properties.length === 0;
        }

        // Add keyboard shortcut for generating instances
        document.addEventListener("keydown", function (e) {
          if (e.metaKey && e.key === "Enter") {
            if (message.properties.length !== 0) {
              GenerateInstances();
            }
          }
        });
      };
    </script>
  </body>
</html>
